<!DOCTYPE html>
<html>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
<meta charset="utf-8" />
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>
<title>Khoa học dữ liệu</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<!-- Style for main home page -->
<link rel="stylesheet" href="/assets/css/styles.css">
<link rel="stylesheet" href="/assets/css/styles_toc.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script data-ad-client="ca-pub-4263248182804679" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> 
<link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Roboto|Source+Sans+Pro" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
<link rel="icon" type="image/jpg" href="assets/images/logo.jpg" sizes="32x32">
<link rel="canonical" href="https://phamdinhkhanh.github.io"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="author" content="Phạm Đình Khánh" />
<meta property="og:title" content="" />
<meta property="og:site_name" content="Khanh's blog" />
<meta property="og:url" content="https://phamdinhkhanh.github.io" />
<meta property="og:description" content="" />

<meta property="og:type" content="article" />
<meta property="article:published_time" content="" />


<meta property="article:author" content="Khanh" />
<meta property="article:section" content="" />

<link rel="alternate" type="application/atom+xml" title="Khanh's blog - Atom feed" href="/feed.xml" />
<style>
	
</style>
<!-- -- Import latext  -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
	skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
	inlineMath: [['$','$']]
  }
});
</script>

<!-- Google Analytics -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-89509207-1', 'auto');
// ga('send', 'pageview');
ga('send', 'pageview', {
'page': '/',
'title': ''
});
</script>


<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KTCD8BX');</script>
<!-- End Google Tag Manager -->
</head>
<style>
body {
  padding: 0 7.5%;
}
</style>

<body>
	<div id="fb-root"></div>
	<!-- <script>(function(d, s, id) { -->
	  <!-- var js, fjs = d.getElementsByTagName(s)[0]; -->
	  <!-- if (d.getElementById(id)) return; -->
	  <!-- js = d.createElement(s); js.id = id; -->
	  <!-- js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.9"; -->
	  <!-- fjs.parentNode.insertBefore(js, fjs); -->
	<!-- }(document, 'script', 'facebook-jssdk'));</script> -->
	<br>
	<div content = "container">
		<div class="row">
			<div class="col-md-2 hidden-xs hidden-sm">
				<a  href="/">
					<img width="100%" style="padding-bottom: 3mm;" src="/assets/images/img.jpg" /> </a>
				<br>
				<nav>
					<div class="header">Latest</div>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/05/28/TransformerThemDauTV.html">Bài 37 - Transformer thêm dấu Tiếng Việt</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/05/23/BERTModel.html">Bài 36 - BERT model</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/05/05/MultitaskLearning_MultiBranch.html">Bài 35 - Multitask Learning - Multi Branch</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/04/22/MultitaskLearning.html">Bài 34 - Multitask Learning</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/04/15/TransferLearning.html">Bài 33 - Phương pháp Transfer Learning</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/04/09/TensorflowDataset.html">Bài 32 - Kĩ thuật tensorflow Dataset</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/04/03/AWS.html">Bài 31 - Amazon Virtual Machine Deep Learning</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/03/28/deployTensorflowJS.html">Bài 30 - Xây dựng Web AI trên tensorflow js</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/03/23/FlaskRestAPI.html">Bài 29 - Xây dựng Flask API cho mô hình deep learning</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/03/21/faceNet.html">Bài 28 - Thực hành training Facenet</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/03/12/faceNetAlgorithm.html">Bài 27 - Mô hình Facenet trong face recognition</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/03/10/DarknetGoogleColab.html">Bài 26 - Huấn luyện YOLO darknet trên google colab</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/03/09/DarknetAlgorithm.html">Bài 25 - YOLO You Only Look Once</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/02/17/ImbalancedData.html">Bài 24 - Mất cân bằng dữ liệu (imbalanced dataset)</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/02/11/NARSyscom2015.html">Bài 23 - Neural Attentive Session-Based Recommendation</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/01/17/ScoreCard.html">Bài 22 - Scorecard model</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2020/01/06/ImagePreprocessing.html">Bài 21 - Tiền xử lý ảnh OpenCV</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/12/26/Sorfmax_Recommendation_Neural_Network.html">Bài 20 - Recommendation Neural Network</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/12/12/ARIMAmodel.html">Bài 19 - Mô hình ARIMA trong time series</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/12/02/DeepLearningLayer.html">Bài 18 - Các layers quan trọng trong deep learning</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/11/22/HOG.html">Bài 17 - Thuật toán HOG (Histrogram of oriented gradient)</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/11/08/RFMModel.html">Bài 16 - Model RFM phân khúc khách hàng</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/11/04/Recommendation_Compound_Part1.html">Bài 15 - collaborative và content-based filtering</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/10/22/googleHeatmap.html">Bài 14 - Biểu đồ trên Google Map</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/10/05/SSDModelObjectDetection.html">Bài 13 - Model SSD trong Object Detection</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/09/29/OverviewObjectDetection.html">Bài 12 - Các thuật toán Object Detection</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/09/16/VisualizationPython.html">Bài 11 - Visualization trong python</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/09/08/LDATopicModel.html">Bài 10 - Thuật toán LDA - Xác định Topic</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/08/25/PyTorch_Torchtext_Tutorial.html">Bài 9 - Pytorch - Buổi 3 - torchtext module NLP</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/08/22/convolutional-neural-network.html">Bài 8 - Convolutional Neural Network</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/08/19/CorrectSpellingVietnamseTonePrediction.html">Bài 7 - Pytorch - Buổi 2 - Seq2seq model correct spelling</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/08/10/PytorchTurtorial1.html">Bài 6 - Pytorch - Buổi 1 - Làm quen với pytorch</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/07/15/PySparkSQL.html">Bài 5 - Model Pipeline - SparkSQL</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/06/18/AttentionLayer.html">Bài 4 -  Attention is all you need</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/05/10/Hypothesis_Statistic.html">Apenddix 1 - Lý thuyết phân phối và kiểm định thống kê</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/04/29/ModelWord2Vec.html">Bài 3 - Mô hình Word2Vec</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/04/22/Ly_thuyet_ve_mang_LSTM.html">Bài 2 - Lý thuyết về mạng LSTM part 2</a></li>
					
					<li><a style="text-align: left; color: #074B80"  href="/2019/01/07/Ky_thuat_feature_engineering.html">Bài 1 - Kĩ thuật feature engineering</a></li>
					
				</nav>
			</div>
			<div class="col-md-8 col-xs-12" style="z-index:1">
				<nav class="navbar navbar-inverse" style="background-color: #046897">
					<div class = "container-fluid">
						<div class = "navbar-header>
							<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
							<a class="navbar-brand" href="/">
								<span style="color:#FFF">Khoa học dữ liệu - Khanh's blog</span>
							</a>
						</div>
						<br>
						<br>
						<div class="collapse navbar-collapse navbar-right" id="myNavbar">
							<ul class="nav navbar-nav">
								<li><a href="/home"><span style="color: #fff"> Home</span></a></li>
								<li><a href="/about"><span style="color: #fff"> About</span></a></li>
								<!-- <li><a href="/da"><span style="color: #fff">Data Analytics</span></a></li> -->
								<!-- <li><a href="/cv"><span style="color: #fff">Computer Vision</span></a></li> -->
								<!-- <li><a href="/nlp"><span style="color: #fff">NLP</span></a></li> -->
								<!-- <li><a href="/code"><span style="color: #fff">Code</span></a></li> -->
								<li><a href="/book"><span style="color: #fff">Book</span></a></li>
							</ul>
						</div>
					</div>
				</nav>
				<div class="PageNavigation">
				</div>
				<h1 itemprop="name" class="post-title"></h1>
				<div id="bootstrap-overrides">
					<div>
<h2><p class="post-link" style="text-align: left; color: #204081; font-weight: bold">Bài 14 - Biểu đồ trên Google Map</p></h2> 
<strong>22 Oct 2019 - phamdinhkhanh</strong>
</div>
<br/>
<div id="toc"></div>
<h1 id="1-các-biểu-đồ-dạng-bản-đồ">1. Các biểu đồ dạng bản đồ</h1>
<p><strong>Bản đồ google map có thể thực hiện được những gì?</strong></p>

<p>Ngày nay cùng với sự phát triển của công cụ google map, việc visualize các báo cáo có liên quan đến vị trí địa lý trở nên dễ dàng hơn. Google map cũng support đa dạng các biểu đồ khác nhau như biểu đồ heatmap, biểu đồ scatter, biểu đồ line và rất nhiều các tùy biến khác trên một bản đồ có khả năng phóng to hoặc thu nhỏ theo view. Người dùng thông qua các điểm trên google map có thể đo lường được vị trí khoảng cách địa lý, phân phối mạng lưới chi nhánh theo khu vực. Các ứng dụng lớn của google map có thể kể đến đó là:</p>

<ul>
  <li>Vẽ các biểu đồ cảnh báo thiên tai: Mức độ động đất, lũ quét, hạn hán,….</li>
  <li>Vẽ các biểu đồ liên quan đến dân số, sản lượng nông nghiệp, công nghiệp.</li>
  <li>Trong bất động sản có thể ứng dụng google map để người mua dễ hình dung vị trí của nhà ở so với các trục đường chính và hệ thống cơ sở hạ tầng xung quanh khu vực.</li>
  <li>Visualize mạng lưới kinh doanh để quản lý và phát triển mạng lưới.</li>
  <li>Đánh dấu vị trí cửa hàng, doanh nghiệp trên google map để tăng lượng khách hàng tiềm năng.
…</li>
</ul>

<p>Và rất nhiều các ứng dụng khác của google map mà ta có thể thực hiện được. Để vẽ một biểu đồ của google map rất đơn giản vì dữ liệu đầu vào cần có tọa độ địa lý <code class="highlighter-rouge">(longtitude, latitude)</code> và giá trị gắn liền với tọa độ địa lý đó.</p>

<p>Bài viết này sẽ hướng dẫn các bạn cách để vẽ các biểu đồ thông dụng trên google map sao cho đẹp mắt, hiệu quả và thể hiện được mục tiêu cần phân tích.</p>

<p>Các tài liệu mà tôi tham khảo để vẽ biểu đồ sẽ được liệt kê ở phần cuối cùng.</p>

<p>Bây h chúng ta sẽ cùng bắt tay việc thực hiện các biểu đồ trên google map nào.</p>

<p><strong>Có thể sử dụng những package nào để visualize bản đồ trên python?</strong></p>

<p>Trên python có rất nhiều các package visualization các bản đồ của google map. Một trong số đó là: <code class="highlighter-rouge">folium, gmplot, gmaps</code>. Các package <code class="highlighter-rouge">gmplot, gmaps</code> đều sử dụng các API của google map. Gần đây việc sử dụng những thông tin này yêu cầu bạn phải có tài khoản trả phí của google. Trái lại <code class="highlighter-rouge">folium</code> sử dụng thông tin bản đồ từ OpenStreetMap là một data mở được chia sẻ tới người dùng. Bên dưới là thông tin giới thiệu về những packages này:</p>

<ul>
  <li>folium: Là một công cụ khai phá dữ liệu mạnh của python kế thừa các tính năng mạnh mẽ của thư viện rất nổi tiếng về map là <code class="highlighter-rouge">Leaflet.js</code> trong javascript.</li>
  <li>gmplot: Là một interface của matplotlib để tạo thành HTML và javascript cho phép render toàn bộ dữ liệu bạn muốn vào một bản đồ trên google map một cách dễ dàng.</li>
  <li>gmaps: Cũng là một Jupyter plugin cho phép nhúng google map vào một jupyter notebook. Các tính năng chính tương tự như gmplot.</li>
</ul>

<p>Trong bài viết này chúng ta sẽ sử dụng thư viện folium là chủ yếu bởi: Biểu đồ không yêu cầu phải sử dụng API key của google map và các graphic cũng đa dạng hơn rất nhiều so với gmplot và gmaps.</p>

<p>Lý thuyết cũng chỉ là lý thuyết. Bây h hãy cùng xem chúng ta có thể tạo được các bản đồ đẹp mắt như thế nào trên google map nào.</p>

<h1 id="2-biểu-đồ-mark">2. Biểu đồ mark</h1>
<p><strong>Ví dụ về đánh dấu chi nhánh</strong></p>

<p>Giả sử công ty bạn có một mạng lưới các chi nhánh phân bố từ bắc vào nam. Bạn không biết làm cách nào để thể hiện khoảng cách giữa các chi nhánh đó. Trước khi có google map công việc thật khó khăn nhưng hiện tại bạn có thể:</p>

<ul>
  <li>Đánh dấu vị trí địa lý các chi nhánh trên bản đồ.</li>
  <li>Thể hiện qui mô doanh số giữa các chi nhánh.</li>
  <li>Phân biệt được các chi nhánh theo vùng quản lý dựa trên màu sắc thay đổi.</li>
</ul>

<p>Tôi sẽ lấy ví dụ một công ty (dữ liệu fake) có khoảng 200 chi nhánh được phân chia thành 7 vùng với mã số từ <code class="highlighter-rouge">R01</code> đến <code class="highlighter-rouge">R07</code> và 2 miền <code class="highlighter-rouge">MB</code> và <code class="highlighter-rouge">MN</code> như bên dưới. Chúng ta sẽ vẽ biểu đồ phân bố chi nhánh theo vùng và thể hiện doanh số của các chi nhánh thông qua 3 packages trên. Dữ liệu chúng ta có thể download tại <a href="https://drive.google.com/file/d/1tbWWs58EedFhIl5DBdnW9p8uB8oSjZSv/view?usp=sharing">DemandBranchFake.xlsx</a>.</p>

<p><strong>Khảo sát dữ liệu</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s">"DemandBranchFake.xlsx"</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s">"DemandBranchFake"</span><span class="p">,</span> 
                        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">,</span> <span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">,</span> <span class="s">'PROVINCE'</span><span class="p">,</span>
                                   <span class="s">'BRANCH_CODE'</span><span class="p">,</span> <span class="s">'AREA'</span><span class="p">,</span> <span class="s">'REGION'</span><span class="p">,</span> <span class="s">'DEMAND'</span><span class="p">],</span>
                        <span class="n">encoding</span><span class="o">=</span><span class="s">"utf8"</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">","</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/20191022_GoogleHeatMap/dataDemandBranchFake.png" width="600px" height="180px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h2 id="21-khởi-tạo-google-map">2.1. Khởi tạo google map</h2>

<p>Việc đầu tiên khi tạo một bản đồ trên google map là chúng ta phải khởi tạo một base map. Một base map sẽ yêu cầu truyền vào giá trị latitude-longtitude (vĩ độ-kinh độ) để xác định tọa độ vị trí tâm bản đồ và mức độ zoom tại thời điểm ban đầu. Từ các giá trị này ta sẽ xác định được bản đồ khởi tạo sẽ hiển thị bắt đầu trên khu vực nào với mức độ phóng đại là bao nhiêu. Chẳng hạn nếu tôi muốn đồ thị của mình hiển thị một khu vực xung quanh Hà Nội với độ zoom không qua lớn tôi có thể thiết lập latitude-longtitude vào khoảng (20.9, 105.8) và mức độ zoom là 12. Trường hợp tôi muốn nhìn toàn bộ các tỉnh ở miền bắc có thể giảm độ zoom xuống 7-8. Điều đó có nghĩa rằng zoom càng to thì càng chi tiết và zoom nhỏ sẽ ít chi tiết nhưng bao phủ một khu vực rộng lớn hơn.</p>

<p>Bên dưới ta sẽ khởi tạo một base map trên package gmplot thông qua hàm <code class="highlighter-rouge">GoogleMapPlotter()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">gmplot</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># Khởi tạo một googleMapPlotter
</span><span class="n">gmap1</span> <span class="o">=</span> <span class="n">gmplot</span><span class="o">.</span><span class="n">GoogleMapPlotter</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
<span class="c1"># Lưu google map vào một html file
</span><span class="n">gmap1</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s">'initialGmplot.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Hiện tại google đã thu phí đối với các API của google map service nên nếu không sử dụng google map key bạn sẽ chỉ có thể xem ở chế độ development mode. Bạn có thể tạo một key của <a href="https://developers.google.com/maps/documentation/embed/get-api-key">google map api</a>, sau khi đã tạo được key thì cần phải enable dịch vụ <a href="https://developers.google.com/maps/documentation/javascript/tutorial">Map API javascript</a> để sử dụng được chế độ tương tác trên javascript. Thủ tục này khá mất công. Sau khi đã gen key, chúng ta cần add key vào bản đồ như bên dưới:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">gmplot</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># Khởi tạo một googleMapPlotter
</span><span class="n">gmap1</span> <span class="o">=</span> <span class="n">gmplot</span><span class="o">.</span><span class="n">GoogleMapPlotter</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
<span class="c1"># Thêm key cho API bằng cách thay thế key vào `your_key`
</span><span class="n">gmap1</span><span class="o">.</span><span class="n">apikey</span> <span class="o">=</span> <span class="s">"your_key"</span>
<span class="c1"># Lưu google map vào một html file
</span><span class="n">gmap1</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s">'initialGmplot.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Theo cách trên bạn sẽ mất phí vì phải sử dụng các google services. Một giải pháp khác đó là package folium. Biểu đồ của folium không đòi hỏi API key, được kế thừa từ thư viện <code class="highlighter-rouge">leaflet.js</code> bên javascript nên trông đẹp mắt và đa dạng hơn.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'initialFolium.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Sau khi mở các file trên các bạn sẽ thu được một bản đồ có dạng:</p>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumInitialMap.png" width="750px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h2 id="22-đánh-dấu-điểm-trên-google-map">2.2. Đánh dấu điểm trên google map</h2>

<p>google map cho phép ta đánh dấu được những vị trí quan trọng trên bản đồ. Đây là một hình thức thu thập và làm giàu dữ liệu từ người dùng rất thông minh của google. Thi thoảng bạn sẽ nhận được những câu hỏi khi đánh dấu một địa điểm trên google map như:</p>

<ul>
  <li>Hãy cho tôi biết địa điểm bạn đang đứng là gì? Mục đích thu thập và làm giàu thông tin.</li>
  <li>Có phải vị trí bạn đang ở gần địa điểm A không? Mục đích là xác thực thông tin người dùng khác đã nhập.</li>
  <li>Hãy tham gia vào hệ thống người đánh dấu địa điểm của google để thu được các tiện ích gì đó (không nhớ rõ). Mục đích là để tạo ra những người dùng trung thành là chuyên gia và có đam mê với đánh dấu địa lý trên google map.</li>
</ul>

<p>Nói tóm lại google có rất nhiều cách thức khác nhau khuyến nghị người dùng bổ sung và làm giàu dữ liệu cho bản đồ của họ. Bản thân tôi cũng là một người thường xuyên đánh dấu lại các địa điểm trên google, nhưng nơi mà tôi đã đến du lịch để lưu lại thời gian, địa điểm như một cuốn nhật ký địa lý. Việc đánh dấu các điểm quan trọng trên bản đồ cũng có thể được sử dụng dễ dàng thông qua object <code class="highlighter-rouge">Marker</code> trong <code class="highlighter-rouge">folium</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">"Nhà của Khánh"</span>
<span class="n">color</span><span class="o">=</span><span class="s">"red"</span>

<span class="c1"># Khởi tạo base map
</span><span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
<span class="c1"># Thêm một marker vào base map
</span><span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">popup</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap2</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumMarker.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumMarker.png" width="750px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Quay trở lại ví dụ về đánh dấu các chi nhánh. Chúng ta có gần 200 chi nhánh trong bộ dữ liệu. Liệu có thể đánh dấu toàn bộ những vị trí của các chi nhánh này? Câu trả lời là hoàn toàn có thể thông qua một vòng lặp đánh dấu từng điểm dữ liệu.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_addMarker</span><span class="p">(</span><span class="n">gmap</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">]),</span> <span class="n">popup</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'BRANCH_CODE'</span><span class="p">])</span>
        <span class="n">marker</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>

<span class="n">_addMarker</span><span class="p">(</span><span class="n">gmap2</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumMarkerMultiple.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Khi đó các điểm trên bản đồ sẽ hiển thị như sau:</p>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumMarkerMultiple.png" width="750px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h1 id="23-nối-các-điểm-trên-google-map-bằng-polyline">2.3. Nối các điểm trên google map bằng polyLine</h1>

<p><strong>Ví dụ về giao vận</strong></p>

<p>Một tình huống khác phát sinh đó là bạn là một đơn vị giao vận (logistic) và cần chuyển hàng từ điểm đến tới điểm đi. Làm sao để biết được giữa các điểm thể hiện trên bản đồ thì đâu là 2 điểm thuộc cùng một chuyến giao hàng (gồm điểm bắt đầu là kho và điểm kết thúc là địa chỉ nhận hàng). Trong <code class="highlighter-rouge">folium</code> biểu đồ <code class="highlighter-rouge">PolyLine</code> sẽ cho phép chúng ta đưa ra một lộ trình bằng cách nối các điểm trong list locations dựa trên kinh độ và vĩ độ của nó. Thực hiện như bên dưới:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_addPolyLine</span><span class="p">(</span><span class="n">gmap</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">]),</span> <span class="n">popup</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'BRANCH_CODE'</span><span class="p">])</span>
        <span class="n">marker</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>
    <span class="n">polyLine</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">PolyLine</span><span class="p">(</span><span class="n">locations</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">])),</span> 
                              <span class="n">line_opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>

<span class="n">dataHN</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s">'PROVINCE'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'Hà Nội'</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">_addPolyLine</span><span class="p">(</span><span class="n">gmap2</span><span class="p">,</span> <span class="n">dataHN</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumPolyLine.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumPolyLine.png" width="750px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h2 id="24-tính-toán-khoảng-cách-theo-đường-chim-bay">2.4. Tính toán khoảng cách theo đường chim bay</h2>

<p>Dựa trên cặp (latitude, longtitude) truyền vào ta có thể tính toán được khoảng cách theo đường chim bay giữa các điểm với nhau.
Khoảng cách được xây dựng dựa trên công thức tính khoảng cách giữa 2 điểm trên một mặt cầu. Bạn đọc quan tâm có thể xem thêm tại <a href="https://en.wikipedia.org/wiki/Great-circle_distance">Great circle distance - wikipedia</a>. Tôi xin phép không đi sâu lan man lý thuyết phần này mà đi vào ứng dụng luôn. Hàm tính khoảng cách khi đã biết tọa độ (latitude, longtitude) của 2 điểm $(X, Y)$ như bên dưới.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">cos</span><span class="p">,</span> <span class="n">asin</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mi">6371</span> <span class="c1"># Bán kính trái đất (km)
</span>    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span> <span class="c1"># giá trị pi/180
</span>    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">cos</span><span class="p">((</span><span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat1</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat2</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos</span><span class="p">((</span><span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">R</span><span class="o">*</span><span class="n">asin</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Chẳng hạn bên dưới ta muốn tính khoảng cách từ tỉnh Vĩnh Long đến thành phố Hồ Chí Minh. Ta sẽ truyền vào tọa độ tương ứng với 2 vị trí này như bên dưới:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1"># Tọa độ Vĩnh Long
</span><span class="n">lat1</span> <span class="o">=</span> <span class="mf">10.250815</span>
<span class="n">lon1</span> <span class="o">=</span> <span class="mf">106.002399</span>
<span class="c1"># Tọa độ thành phố Hồ Chí Minh
</span><span class="n">lat2</span> <span class="o">=</span> <span class="mf">10.678836</span>
<span class="n">lon2</span> <span class="o">=</span> <span class="mf">106.601911</span>
<span class="c1"># Tính khoảng cách
</span>
<span class="n">distance</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>81.00896435483854
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="25-bản-đồ-heatmap">2.5. Bản đồ heatmap</h2>

<p>Bản đồ heatmap hay còn gọi là bản đồ nhiệt là một trong những bản đồ thể hiện độ lớn thông qua cường độ màu sắc, rất hiệu quả trong việc đo lường giá trị cường độ theo vùng địa lý. Heatmap thường được sử dụng trong các biểu đồ cảnh báo thiên tai hoặc biểu đồ về phân bố lượng mưa, lượng nhiệt.</p>

<p>Trong kinh doanh heatmap cũng rất hiệu quả trong việc thể hiện phân bố doanh số theo vùng. Giả sử dựa trên nhu cầu tiêu thụ của các vùng miền chúng ta muốn vẽ một bản đồ heatmap để hiển thị những vùng có nhu cầu tiêu thụ lớn và tập trung và những vùng có nhu cầu tiêu thụ ít. Chúng ta thực hiện như sau:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMap</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap</span><span class="p">):</span>
    <span class="n">data_loc_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">]))</span>
    <span class="n">heatMap</span> <span class="o">=</span> <span class="n">HeatMap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_loc_val</span><span class="p">,</span> 
            <span class="n">min_opacity</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">,</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> 
            <span class="n">overlay</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">heatMap</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>
    
<span class="n">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap2</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumHeatMap.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumHeatMap.png" width="750px" height="500px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Nhìn vào bản đồ ta có thể thấy Hà Nội và Hồ Chí Minh là hai thành phố có nhu cầu tiêu thụ lớn nhất khi màu sắc được thể hiện đậm hơn trên heatmap. Ngoài ra, khi zoom chi tiết vào các khu vực này ta còn có thể thấy được ở từng phường, quận mức độ tiêu thụ như thế nào?</p>

<p><strong>Làm thế nào để đánh dấu điểm quan trọng trên heatmap?</strong></p>

<p>Khi theo dõi heatmap chúng ta có thể cần đánh dấu những vị trí quan trọng trên bản đồ để tìm vị trí đặt chi nhánh. Khi đó chỉ cần thêm một layer vào bản đồ gốc sao cho layer này cho phép khởi tạo các marker. Hàm <code class="highlighter-rouge">ClickFormarker()</code> trong folium cho phép ta tạo một layer như vậy.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMap</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap</span><span class="p">):</span>
    <span class="n">data_loc_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">]))</span>
    <span class="n">heatMap</span> <span class="o">=</span> <span class="n">HeatMap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_loc_val</span><span class="p">,</span> 
            <span class="n">min_opacity</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">,</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> 
            <span class="n">overlay</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">heatMap</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>

<span class="n">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap2</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">ClickForMarker</span><span class="p">(</span><span class="n">popup</span><span class="o">=</span><span class="s">'Chi nhánh tiềm năng'</span><span class="p">))</span>

<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumHeatMapClickForMarker.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Kết quả sau khi right click vào những vị trí được đánh dấu trên bản đồ:</p>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumHeatMapClickForMarker.png" width="500px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Ta có thể khoanh thêm vùng cho các vị trí lõi dựa vào layer <code class="highlighter-rouge">Circle()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMap</span>
<span class="kn">from</span> <span class="nn">folium.features</span> <span class="kn">import</span> <span class="n">DivIcon</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">text</span> <span class="o">=</span> <span class="s">"Hà Nội"</span>
<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap</span><span class="p">):</span>
    <span class="n">data_loc_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">]))</span>
    <span class="n">heatMap</span> <span class="o">=</span> <span class="n">HeatMap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_loc_val</span><span class="p">,</span> 
            <span class="n">min_opacity</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">,</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> 
            <span class="n">overlay</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">heatMap</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>

<span class="n">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap2</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">ClickForMarker</span><span class="p">(</span><span class="n">popup</span><span class="o">=</span><span class="s">'Chi nhánh tiềm năng'</span><span class="p">))</span>
<span class="c1"># Thêm circle có bán kính 15000
</span><span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Circle</span><span class="p">([</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">],</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>
<span class="c1"># Thêm text chú thích cho circle
</span><span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
    <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">],</span>
    <span class="n">icon</span><span class="o">=</span><span class="n">DivIcon</span><span class="p">(</span>
        <span class="n">icon_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span>
        <span class="n">icon_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">html</span><span class="o">=</span><span class="s">'&lt;div style="font-size: 24pt"&gt;</span><span class="si">%</span><span class="s">s&lt;/div&gt;'</span> <span class="o">%</span> <span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">))</span>

<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumHeatMapClickForMarker.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Kết quả:</p>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumMarkerCircle.png" width="500px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Chúng ta cũng có thể thay đổi màu sắc cho đồ thị Heatmap thông qua việc điều chỉnh gradient của hàm <code class="highlighter-rouge">Heatmap()</code> bằng cách thay đổi cường độ của các màu sắc bên trong. Chẳng hạn tôi muốn heatmap có một màu đỏ hơn thì cần điều chỉnh trọng số của heatmap cao hơn. Giá trị mà tôi thiết lập cho gradient là: <code class="highlighter-rouge">{0.2: 'blue', 0.4: 'lime', 0.6: 'orange', 1: 'red'}</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMap</span>
<span class="kn">from</span> <span class="nn">folium.features</span> <span class="kn">import</span> <span class="n">DivIcon</span>

<span class="n">lat</span> <span class="o">=</span> <span class="mf">20.97</span>
<span class="nb">long</span> <span class="o">=</span> <span class="mf">105.8</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">text</span> <span class="o">=</span> <span class="s">"Hà Nội"</span>
<span class="n">gmap2</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap</span><span class="p">):</span>
    <span class="n">data_loc_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LATITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DELIVERY_WARD_LONGITUDE'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'DEMAND'</span><span class="p">]))</span>
    <span class="n">heatMap</span> <span class="o">=</span> <span class="n">HeatMap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_loc_val</span><span class="p">,</span> 
            <span class="n">min_opacity</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="c1"># Thay đổi màu sắc bằng gradient
</span>            <span class="n">gradient</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.2</span><span class="p">:</span> <span class="s">'blue'</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">:</span> <span class="s">'lime'</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">:</span> <span class="s">'orange'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">'red'</span><span class="p">},</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">,</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> 
            <span class="n">overlay</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">heatMap</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">gmap</span><span class="p">)</span>

<span class="n">_addHeatMap</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">gmap2</span><span class="p">)</span>
<span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">ClickForMarker</span><span class="p">(</span><span class="n">popup</span><span class="o">=</span><span class="s">'Chi nhánh tiềm năng'</span><span class="p">))</span>
<span class="c1"># Thêm circle có bán kính 15000
</span><span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Circle</span><span class="p">([</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">],</span> <span class="n">radius</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="bp">True</span><span class="p">))</span>
<span class="c1"># Thêm text chú thích cho circle
</span><span class="n">gmap2</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
    <span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">],</span>
    <span class="n">icon</span><span class="o">=</span><span class="n">DivIcon</span><span class="p">(</span>
        <span class="n">icon_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span><span class="mi">36</span><span class="p">),</span>
        <span class="n">icon_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">html</span><span class="o">=</span><span class="s">'&lt;div style="font-size: 24pt"&gt;</span><span class="si">%</span><span class="s">s&lt;/div&gt;'</span> <span class="o">%</span> <span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">))</span>

<span class="n">gmap2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"foliumHeatMapClickForMarker.html"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumMarkerCircleRed.png" width="500px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h2 id="26-bản-đồ-heatmap-theo-thời-gian">2.6. Bản đồ heatmap theo thời gian</h2>

<p>Khi xem một bản đồ heatmap thường phân phối màu sắc sẽ thay đổi theo thời gian. Cũng giống như các bạn xem bản đồ về diện tích của bắc cực và nam cực theo 4 mùa trong năm, diện tích các cực sẽ mở rộng hoặc thu hẹp theo từng mùa. Để tracking được những biến đổi này chúng ta cần sử dụng tới biểu đồ time heatmap.</p>

<p>Để demo cho cách tạo một biểu đồ time heatmap tôi sẽ lấy ví dụ về dữ liệu độ dài của các chuyến đi taxi trong năm 2016 được lấy từ cuộc thi <a href="https://www.kaggle.com/c/nyc-taxi-trip-duration/data">NYC taxi trip duration</a>. Dựa trên các thông tin về chuyến đi người dùng cần dự báo xem chuyến đi sẽ kéo dài trong bao lâu. Dữ liệu gồm các trường như sau:</p>

<ul>
  <li>id: Mã số chuyến đi. Là trường key xác định duy nhất.</li>
  <li>vendor_id: Là mã số ám chỉ hãng taxi cung cấp chuyến đi.</li>
  <li>pickup_datetime: Ngày và giờ chuyến đi bắt đầu chuyển bánh.</li>
  <li>dropoff_datetime: Ngày và giờ chuyến đi kết thúc.</li>
  <li>passenger_count: Số lượng hành khách trên chuyến đi.</li>
  <li>pickup_longitude: Kinh độ của vị trí đón khách.</li>
  <li>pickup_latitude: Vĩ độ của vị trí đón khách.</li>
  <li>dropoff_longitude: Kinh độ vị trí trả khách.</li>
  <li>dropoff_latitude: Vĩ độ vị trí trả khách.</li>
  <li>store_and_fwd_flag: Đánh dấu bản ghi chuyến đi đã được lưu lại trên bộ nhớ của phương tiện trước khi gửi tới hãng taxi.</li>
  <li>trip_duration: Độ dài của chuyến đi.</li>
</ul>

<p><strong>Đọc và xử lý dữ liệu:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="n">dataTaxiTrip</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'nyc-taxi-trip-duration/test/test.csv'</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 625134 entries, 0 to 625133
Data columns (total 14 columns):
id                    625134 non-null object
vendor_id             625134 non-null int64
pickup_datetime       625134 non-null datetime64[ns]
passenger_count       625134 non-null int64
pickup_longitude      625134 non-null float64
pickup_latitude       625134 non-null float64
dropoff_longitude     625134 non-null float64
dropoff_latitude      625134 non-null float64
store_and_fwd_flag    625134 non-null object
month                 625134 non-null int64
week                  625134 non-null int64
day                   625134 non-null int64
hour                  625134 non-null int64
count                 625134 non-null int64
dtypes: datetime64[ns](1), float64(4), int64(7), object(2)
memory usage: 66.8+ MB
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Để làm việc với thời gian chúng ta cần trích xuất các thành phần thời gian (month, week, day, hour) của thời điểm đón khách.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_extract_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">pickup_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S'</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'week'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">week</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'day'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'hour'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pickup_datetime</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    
<span class="n">_extract_datetime</span><span class="p">(</span><span class="n">dataTaxiTrip</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 625134 entries, 0 to 625133
Data columns (total 14 columns):
id                    625134 non-null object
vendor_id             625134 non-null int64
pickup_datetime       625134 non-null datetime64[ns]
passenger_count       625134 non-null int64
pickup_longitude      625134 non-null float64
pickup_latitude       625134 non-null float64
dropoff_longitude     625134 non-null float64
dropoff_latitude      625134 non-null float64
store_and_fwd_flag    625134 non-null object
month                 625134 non-null int64
week                  625134 non-null int64
day                   625134 non-null int64
hour                  625134 non-null int64
count                 625134 non-null int64
dtypes: datetime64[ns](1), float64(4), int64(7), object(2)
memory usage: 66.8+ MB
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Đầu tiên ta sẽ khởi tạo map tại vị trí trung bình của vĩ độ và kinh độ của các địa điểm đón taxi. Việc này để đảm bảo bản đồ heatmap được bao trọn trong khung hình của đồ thị.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lat</span> <span class="o">=</span> <span class="n">dataTaxiTrip</span><span class="p">[</span><span class="s">'pickup_latitude'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">long</span> <span class="o">=</span> <span class="n">dataTaxiTrip</span><span class="p">[</span><span class="s">'pickup_longitude'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">gmapNYTaxi</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">],</span> <span class="n">zoom_start</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">)</span>
<span class="c1"># gmapNYTaxi.save('foliumNYTaxi.html')
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Thêm heatmap layer khởi tạo vào bản đồ.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMap</span>

<span class="n">dataTaxiTrip</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">HeatMap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTaxiTrip</span><span class="p">[[</span><span class="s">'pickup_latitude'</span><span class="p">,</span> <span class="s">'pickup_longitude'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">]]</span>
                  <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'pickup_latitude'</span><span class="p">,</span> <span class="s">'pickup_longitude'</span><span class="p">])</span>
                  <span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
                  <span class="n">radius</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                  <span class="n">max_zoom</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">gmapNYTaxi</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>
<span class="n">gmapNYTaxi</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'foliumHeatMapNY.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Kết quả:</p>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumNYTaxi.png" width="750px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Như vậy ta thu được một heatmap biểu diễn số lượng chuyến đi theo địa điểm cho toàn bộ năm 2016.</p>

<p><strong>Tạo heatmap đếm số lượng chuyến đi theo từng khung giờ cho toàn bộ năm 2016</strong></p>

<p>Ta nhận thấy rằng nhu cầu về taxi sẽ thay đổi theo thời gian. Ban đêm sẽ ít hơn so với ban ngày. Do đó ta sẽ cần tạo một biểu đồ heatmap theo thời gian mà phân chia được các chuyến đi theo khung giờ trong ngày. Trước tiên ta cần chuẩn bị dữ liệu là list các thống kê số lượng chuyến đi theo từng tọa độ tại mỗi một khung giờ. List sẽ bao gồm 24 phần tử đại diện cho 24 khung giờ khác nhau. Số liệu thống kê là số chuyến taxi xảy ra trong cùng một giờ trong toàn bộ năm 2016.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">dataTaxiTrip_hour_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">dataTaxiTrip_hour_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataTaxiTrip</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">hour</span><span class="p">,</span> 
                                    <span class="p">[</span><span class="s">'pickup_latitude'</span><span class="p">,</span> <span class="s">'pickup_longitude'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">]]</span>
                        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'pickup_latitude'</span><span class="p">,</span> <span class="s">'pickup_longitude'</span><span class="p">])</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Vẽ biểu đồ HeatMap biến đổi theo thời gian</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">folium.plugins</span> <span class="kn">import</span> <span class="n">HeatMapWithTime</span>


<span class="n">lat</span> <span class="o">=</span> <span class="n">dataTaxiTrip</span><span class="p">[</span><span class="s">'pickup_latitude'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">long</span> <span class="o">=</span> <span class="n">dataTaxiTrip</span><span class="p">[</span><span class="s">'pickup_longitude'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>

<span class="n">gmapNYTaxi</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">],</span> <span class="n">zoom_start</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">)</span>

<span class="n">heatmap</span> <span class="o">=</span> <span class="n">HeatMapWithTime</span><span class="p">(</span><span class="n">dataTaxiTrip_hour_list</span><span class="p">,</span> 
                          <span class="n">radius</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                          <span class="n">gradient</span><span class="o">=</span><span class="p">{</span><span class="mf">0.2</span><span class="p">:</span> <span class="s">'blue'</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">:</span> <span class="s">'lime'</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">:</span> <span class="s">'orange'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">'red'</span><span class="p">},</span> 
                          <span class="n">min_opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                          <span class="n">max_opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
                          <span class="n">use_local_extrema</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">gmapNYTaxi</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>
<span class="n">gmapNYTaxi</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'foliumHeatMapWithTimeNY.html'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Kết quả:</p>

<p><img src="/assets/images/20191022_GoogleHeatMap/foliumHeatMapWithTimeNY.gif" width="750px" height="400px" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h1 id="3-tổng-kết">3. Tổng kết</h1>

<p>Như vậy qua bài viết này tôi đã giới thiệu đến các bạn những biểu đồ cơ bản nhất trên google map bao gồm: Marker, CicleMarker, polyLine, Heatmap. Các biểu đồ này có thể được sử dụng kết hợp với nhau một cách linh hoạt để tạo ra những báo cáo ấn tượng. Tôi cũng hi vọng rằng sau khi đọc bài viết này các bạn sẽ có thể áp dụng được vào thực tiễn vào các dự án của mình.</p>

<p>Ngoài ra các dạng biểu đồ google map hiện nay còn được tích hợp sẵn trên power BI, tableau, data studio và nhiều phần mềm visualize khác. Có thời gian tôi sẽ giới thiệu thêm về cách thức tạo báo cáo google map trên những công cụ này.</p>

<p>Cuối cùng không thể thiếu là phần tổng kết những tài liệu mà tôi đã tham khảo.</p>

<h1 id="4-tài-liệu">4. Tài liệu.</h1>

<ol>
  <li><a href="https://blog.dominodatalab.com/creating-interactive-crime-maps-with-folium/">creating interactive crime maps with folium - blog dominodatalab</a></li>
  <li><a href="https://www.kaggle.com/daveianhickey/how-to-folium-for-maps-heatmaps-time-analysis">folium for maps heatmaps time analysis - kaggle daveanhickey</a></li>
  <li><a href="https://www.tutorialspoint.com/plotting-google-map-using-gmplot-package-in-python">plotting google map using gmplot package in python - tutorialspoint</a></li>
</ol>

<script data-ad-client="ca-pub-4263248182804679" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<button onclick="topFunction()" id="myBtn" title="Go to top">Top</button>

<script src="/js/toc.js"></script>
<script src="/js/btnTop.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    $('#toc').toc();
});
</script>
				</div>
			</div>
			<div class="col-md-2 hidden-xs hidden-sm">
				<a  href="/">
					<img width="100%" style="padding-bottom: 3mm;" src="/assets/images/logo.jpg" /> </a>
				<br>
				<nav>
					<div class="header">Khanh's site</div>
					<li><a style="text-align: left; color: #074B80"  href="https://www.facebook.com/TowardDataScience">phamdinhkhanh blog</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://www.facebook.com/groups/3235479620010379/">phamdinhkhanh AICode forum</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://kaggle.com/phamdinhkhanh">phamdinhkhanh kaggle</a></li>
					<li><a style="text-align: left; color: #074B80"  href="http://rpubs.com/phamdinhkhanh">phamdinhkhanh rpub</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://github.com/phamdinhkhanh">phamdinhkhanh github</a></li>
					<br>
					<div class="header">other's site</div>
					<li><a style="text-align: left; color: #074B80"  href="https://www.facebook.com/groups/machinelearningcoban/">machine learning cơ bản facebook</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://forum.machinelearningcoban.com/">machine learning cơ bản forum</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://machinelearningmastery.com">machine learning mastery</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://viblo.asia">viblosia</a></li>
					<br>
					<div class="header">Khóa học</div>
					<li><a style="text-align: left; color: #074B80"  href="http://web.stanford.edu/class/cs109/">Xác suất thống kê(Probability): CS109</a></li>
					<li><a style="text-align: left; color: #074B80"  href="http://web.stanford.edu/class/cs246/">Bigdata: CS246</a></li>
					<li><a style="text-align: left; color: #074B80"  href="http://cs231n.stanford.edu/">Computer vision cơ bản: CS231N</a></li>
					<li><a style="text-align: left; color: #074B80"  href="http://web.stanford.edu/class/cs224n/">Natural Language Processing: CS224N</a></li>
					<li><a style="text-align: left; color: #074B80"  href="http://web.stanford.edu/class/cs224w/">Khoá phân tích mạng lưới (analysis of network): CS224W</a></li>
					<li><a style="text-align: left; color: #074B80"  href="https://web.stanford.edu/class/cs20si/">Khóa học Tensorflow: CS20SI</a></li>
				</nav>
			</div>
		</div>
	</div>
	
</body>
</html>
